name: $(SourceBranchName)_$(Build.SourceVersion)

trigger:
 branches:
    include:
      - main

pr: none

pool:
  vmImage: 'ubuntu-24.04'

steps:
- script: |
    aws ecr get-login-password --region $(AWS_REGION) | docker login --username AWS --password-stdin $(AWS_ACCOUNTID).dkr.ecr.$(AWS_REGION).amazonaws.com
  displayName: 'Login to Aws and ECR'
  env:
    AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
    AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)

- task: Bash@3
  displayName: Build app with Docker
  inputs:
      targetType: 'inline'
      script: |
        docker build -t $(DOCKER_REPOSITORYNAME) .

- task: Bash@3
  displayName: 'Scan Docker Image with Trivy'
  inputs:
    targetType: 'inline'
    script: |
      sudo apt-get install -y wget gnupg2
      sudo apt install jq -y
      # Obtener la última versión de Trivy dinámicamente
      TRIVY_VERSION=$(curl -s https://api.github.com/repos/aquasecurity/trivy/releases/latest | grep -oP '"tag_name": "\K[^"]+' | sed 's/v//')
      if [ -z "$TRIVY_VERSION" ]; then
        echo "Warning: Could not fetch latest Trivy version, using fallback v0.67.0"
        TRIVY_VERSION="0.67.0"
      fi
      echo "Installing Trivy version: $TRIVY_VERSION"
      wget https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_Linux-64bit.deb
      sudo dpkg -i trivy_${TRIVY_VERSION}_Linux-64bit.deb

      echo "Docker image '$DOCKER_REPOSITORYNAME' built successfully."

      # Run vulnerability scan with Trivy
      echo "Starting vulnerability scan on the image..."
      trivy image --severity CRITICAL,HIGH,MEDIUM,LOW --exit-code 1 "$DOCKER_REPOSITORYNAME"

      # Check scan result
      if [ $? -ne 0 ]; then
        echo "Vulnerabilities detected in image '$DOCKER_REPOSITORYNAME'."
        exit 1
      else
        echo "No critical, high, or medium vulnerabilities found."
        exit 0
      fi

- task: Bash@3
  displayName: 'Tag Docker image with commit SHA'
  inputs:
    targetType: 'inline'
    script: |
      echo "Git commit: $(Build.SourceVersion)"
      docker tag $(DOCKER_REPOSITORYNAME):latest $(AWS_ACCOUNTID).dkr.ecr.$(AWS_REGION).amazonaws.com/$(DOCKER_REPOSITORYNAME):$(Build.SourceVersion)
      docker tag $(DOCKER_REPOSITORYNAME):latest $(AWS_ACCOUNTID).dkr.ecr.$(AWS_REGION).amazonaws.com/$(DOCKER_REPOSITORYNAME):latest

- task: Bash@3
  displayName: 'Push Docker image to ECR'
  inputs:
    targetType: 'inline'
    script: |
      echo "Pushing image with tag: $(Build.SourceVersion)"
      docker push $(AWS_ACCOUNTID).dkr.ecr.$(AWS_REGION).amazonaws.com/$(DOCKER_REPOSITORYNAME):$(Build.SourceVersion)
      docker push $(AWS_ACCOUNTID).dkr.ecr.$(AWS_REGION).amazonaws.com/$(DOCKER_REPOSITORYNAME):latest
      echo "Image pushed successfully to ECR"