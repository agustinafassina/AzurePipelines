name: $(SourceBranchName)_$(Build.SourceVersion)

trigger:
 branches:
    include:
      - main

pr: none

pool:
  vmImage: 'ubuntu-24.04'

steps:
- script: |
    aws ecr get-login-password --region $(AWS_REGION) | docker login --username AWS --password-stdin $(AWS_ACCOUNTID).dkr.ecr.$(AWS_REGION).amazonaws.com
  displayName: 'Login to AWS and ECR'
  env:
    AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
    AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)

- task: PowerShell@2
  displayName: 'Generate pipeline metadata'
  continueOnError: true
  inputs:
    targetType: 'inline'
    script: |
      $fileName = "pipeline-detail.json"
      
      # Validar que package.json existe
      if (Test-Path "package.json") {
        try {
          $filePackageJsonVersion = Get-Content "package.json" | ConvertFrom-Json
          $appVersion = $filePackageJsonVersion.version
        } catch {
          Write-Warning "Error reading package.json: $_"
          $appVersion = "unknown"
        }
      } else {
        Write-Warning "package.json not found, using default version"
        $appVersion = "unknown"
      }
      
      # Crear objeto con metadata del pipeline
      $pipelineDetail = @{
        Message = "$(Build.SourceVersionMessage)"
        OwnerBranch = "$(Build.SourceVersionAuthor)"
        AppVersion = $appVersion
        CommitId = "$(Build.SourceVersion)"
        BranchName = "$(Build.SourceBranchName)"
        BuildId = "$(Build.BuildId)"
        BuildNumber = "$(Build.BuildNumber)"
      }
      
      # Convertir a JSON de forma segura
      $jsonPipelineDetail = $pipelineDetail | ConvertTo-Json -Compress
      
      # Guardar archivo
      $jsonPipelineDetail | Out-File -FilePath $fileName -Encoding utf8 -NoNewline
      
      Write-Host "Pipeline metadata generated:"
      Get-Content $fileName

- task: CopyFiles@2
  displayName: 'Copy metadata artifact'
  inputs:
    SourceFolder: '$(Build.SourcesDirectory)'
    Contents: 'pipeline-detail.json'
    TargetFolder: '$(Build.ArtifactStagingDirectory)'
    continueOnError: true

- task: PublishBuildArtifacts@1
  displayName: 'Publish metadata artifact'
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)'
    ArtifactName: 'pipeline-metadata'
    publishLocation: 'Container'
    continueOnError: true

- task: Bash@3
  displayName: Build app container image
  inputs:
      targetType: 'inline'
      script: |
        docker build -t $(DOCKER_REPOSITORYNAME) .

- task: Bash@3
  displayName: 'Tag Docker image with commit SHA and latest'
  inputs:
    targetType: 'inline'
    script: |
      echo "GIT COMMIT IS: $(Build.SourceVersion)"
      docker tag $(DOCKER_REPOSITORYNAME):latest $(AWS_ACCOUNTID).dkr.ecr.$(AWS_REGION).amazonaws.com/$(DOCKER_REPOSITORYNAME):$(Build.SourceVersion)
      docker tag $(DOCKER_REPOSITORYNAME):latest $(AWS_ACCOUNTID).dkr.ecr.$(AWS_REGION).amazonaws.com/$(DOCKER_REPOSITORYNAME):latest

- task: Bash@3
  displayName: 'Push Docker image to ECR'
  inputs:
    targetType: 'inline'
    script: |
      echo "Pushing image with tags: $(Build.SourceVersion) and latest"
      docker push $(AWS_ACCOUNTID).dkr.ecr.$(AWS_REGION).amazonaws.com/$(DOCKER_REPOSITORYNAME):$(Build.SourceVersion)
      docker push $(AWS_ACCOUNTID).dkr.ecr.$(AWS_REGION).amazonaws.com/$(DOCKER_REPOSITORYNAME):latest
      echo "Image pushed successfully to ECR"